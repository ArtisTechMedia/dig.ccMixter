<!DOCTYPE html>
<html>
<head>
  <title>dig.ccmixter</title>
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap-theme.min.css">
  <link rel="stylesheet" href="css/screen.css">
</head>
<body class='well'>
  <!-- HANDLEBARS TEMPLATES -->
  <script type="text/x-handlebars">
    <div class='navbar navbar navbar-fixed-top'>
      <div class='navbar-inner'>
        {{#linkTo "index" class="navbar-brand"}}<img
          src="http://dig.ccmixter.org/images/logo.png"
          alt="dig.ccMixter"
        />{{/linkTo}}
        <div class='navbar-collapse collapse'>
          <ul class='nav navbar-nav navbar-right'>
            <li>{{#linkTo "uploads" "sort=rank" title="Highest ranked tracks on ccMixter"}}Top{{/linkTo}}</li>
            <li>{{#linkTo "uploads" "sort=score" title="Tracks most recommended by ccMixter users"}}Recommended{{/linkTo}}</li>
            <li>{{#linkTo "uploads" "lic=open&sort=rank" title="Free for Commercial Use"}}Free{{/linkTo}}</li>
            <li>{{#linkTo "uploads" "sort=date"}}New{{/linkTo}}</li>
            <li>{{#linkTo "about"}}About{{/linkTo}}</li>
          </ul>
        </div>
      </div>
    </div>
    <section class='main'>{{outlet}}</section>
    <div class='navbar navbar navbar-footer'>
      <div class='navbar-inner'>
        {{outlet nowPlaying}}
      </div>
    </div>
  </script>
  <script type="text/x-handlebars" data-template-name="loading">
    <h2 class='loading container'>Loading...</h2>
  </script>
  <script type="text/x-handlebars" data-template-name="error">
    <div class='container'>
      {{partial "digBar"}}
      <h2 class='loading error'>Error Loading Page</h2>
    </div>
  </script>
  <script type="text/x-handlebars" data-template-name="index">
    <article class='homepage container'>
      {{partial "digBar"}}
      <h2>ccMixter Music Discovery <span class='badge beta'>(BETA)</span></h2>
      <h3>&ldquo;With Attribtuion: You Already Have Permission&hellip;&rdquo;</h3>
    </article>
  </script>
  <script type="text/x-handlebars" data-template-name="about">
    <article class='about container'>
      {{partial "digBar"}}
      <h2>About Us</h2>
      <div class='row well'>
        <div class='col-sm-6'>
          <p><strong>dig.ccmixter</strong> is where people come to find fantastic, liberally licensed music. The musicians' community at <a href="http://ccmixter.org">ccMixter</a> make modern, challenging, but satisfying music that they want you to hear! There's a reason why <em>1 out of 6 tracks at dig.ccmixter are already being used by video makers and podcasters</em></p>
        </div><div class='col-sm-6'>
          <p><strong>dig.ccmixter</strong> is devoted to helping you find that great music, all of which is liberally licensed under a <a href="http://creativecommons.org">Creative Commons</a> license so you <em>already have permission</em> to use this music in your video, podcast, school project, personal music player, or where ever&hellip; We even have several 1,000 tracks that <em>already have permission</em> to use in <strong>commercial projects</strong> for free.</p>
        </div>
      </div>

      <section class='credits'>
        <h3>Credits</h3>
        <p>Logo and original site design by <a href="http://nvzion.com">nvzion</a></li>
        <p>Concept, coding and nusance <a href="http://fourstones.net">Victor Stone</a></p>
        <p>More coding and 2.0 revamp <a href="http://tunetrack.net/go1dfish">Alex Goodwin</a></p>
        <p>All music provided by the <a href="http://ccmixter.org">ccMixter</a> community of singer, musicians and producers.</p>
        <p>Produced by <a href="http://artistechmedia.com">ArtIsTech Media</a>.</p>
      </section>

      <section class='logos'>
        <a href="http://ccmixter.org"><img src="http://dig.ccmixter.org/images/ccmixter-h.jpg" alt="Visit ccmixter"></a>
        <a href="http://tunetrack.net"><img src="http://dig.ccmixter.org/images/tunetrack-h.jpg" alt="Visit TuneTrack"></a>
        <a href="http://artistechmedia.com"><img src="http://dig.ccmixter.org/images/artistech-h.jpg" alt="Visit ArtisTech Media"></a>
        <a href="http://creativecommons.org"><img src="http://dig.ccmixter.org/images/cc-h.jpg" alt="Visit Creative Commons"></a>
      </section>
    </article>
  </script>
  <script type="text/x-handlebars" data-template-name="nowPlaying">
    <section class='now-playing'>
    {{#if content}}
      {{#with content}}{{partial "uploadsItem"}}{{/with}}
    {{/if}}
    </section>
  </script>
  <script type="text/x-handlebars" data-template-name="digBar">
    <section class='dig-bar'>
      <div class="input-group search-dig">
        {{input class="form-control" value=newArgs placeholder="ccMixter Query API 2.0 URL Arguments" size="128"}}
        {{#linkTo "uploads" newArgs class='input-group-addon btn btn-default'}}
          dig
        {{/linkTo}}
      </div>
    </section>
  </script>
  <script type="text/x-handlebars" data-template-name="uploads">
    <article class='uploads container'>
      {{partial "digBar"}}
      <ul class='api uploads media-list'>
      {{#each}}<li class='media upload'>{{partial "uploadsItem"}}</li>{{/each}}
      </ul>
    </article>
  </script>
  <script type="text/x-handlebars" data-template-name="uploadsItem">
    <article {{bindAttr class=":upload isPlaying"}}>
      <div class='btn-group pull-left'>
        <a href='#' {{action playPrevious}} class='btn pull-left play-previous'><span class="glyphicon glyphicon-backward"></span></a>
        <a href='#' {{action togglePlay}} class='btn pull-left play'>
          <span {{bindAttr class=":glyphicon isPlaying:glyphicon-pause:glyphicon-play"}}></span>
        </a>
        <a href='#' {{action playNext}} class='btn pull-left play-next'><span class="glyphicon glyphicon-forward"></span></a>
      </div>
      <div class='media-body'>
        <a class='license pull-right' target='_new' href='{{unbound license_url}}'><img
          src="{{unbound license_logo_url}}"
          alt="{{unbound license_name}}"
          title="{{unbound license_name}}"
        /></a>
        <h4 class='media-heading'>{{unbound upload_name}}</h4>
        <div class='attribution'>
          by {{#linkTo 'uploads' userQuery class='user'}}{{unbound user_name}}{{/linkTo}}
        </div>
        <div class='clearfix'></div>
      </div>
      <div class='clearfix'></div>
    </article>
  </script>
  <!-- END HANDLEBARS TEMPLATES -->

  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.4.0/moment.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.0.2/js/bootstrap.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.1.2/handlebars.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/ember.js/1.2.0-beta.4/ember.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/URI.js/1.7.2/URI.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/pagedown/1.0/Markdown.Converter.min.js"></script>
  <script src="soundmanagerv297a-20131201/script/soundmanager2.js"></script>

  <!-- BEGIN JAVSCRIPT -->

  <script type="text/javascript">
    var Dig = Em.Application.create();

    // ROUTER

    Dig.Router.map(function() {
      this.resource('about');
      this.resource('uploadsIndex', {path: '/tracks'});
      this.resource('uploads', {path: '/tracks/*args'});
    });

    // ROUTES

    Dig.ApplicationRoute = Em.Route.extend({
      renderTemplate: function() {
        this._super.apply(this, arguments);
        this.render('nowPlaying', {
          into: 'application',
          outlet: 'nowPlaying'
        });
      },
      actions: {
        togglePlay: function() {
          var currentTrack = this.controllerFor('nowPlaying').get('content');
          if (currentTrack) {
            currentTrack.togglePlay();
          }
        },
        playPrevious: function() {
          this.controllerFor('nowPlaying').playPreviousTrack();
        },
        playNext: function() {
          this.controllerFor('nowPlaying').playNextTrack();
        }
      }
    });

    Dig.ApiRoute = Em.Route.extend({
      baseUrl: "http://ccmixter.org/api/query?f=json&",
      model: function(params) {
        var url = this.get('baseUrl');
        if (params.args) {
          url += params.args;
        }
        return Ember.RSVP.resolve($.ajax({url: url, dataType: 'json'}).then(function(response) {
          response.args = params.args;
          return response;
        }));
      },
      serialize: function(model) {
        if (model) {
          if (typeof(model) === 'string') {
            return {args: model};
          }
          return {args: model.args};
        }
        return {args: ''};
      }
    });

    Dig.UploadsRoute = Dig.ApiRoute.extend({
      baseUrl: "http://ccmixter.org/api/query?f=json&limit=15&datasource=uploads&",
    });

    Dig.UploadsIndexRoute = Em.Route.extend({
      redirect: function() {this.transitionTo('uploads', '');}
    });

    // END ROUTES

    // CONTROLLERS

    Dig.ApiController = Em.ArrayController.extend({
      itemController: 'apiItem',

      newArgs: function() {
        return this.get('content.args') || '';
      }.property('content'),
    });
    Dig.ApiItemController = Em.ObjectController.extend();

    Dig.UploadsController = Dig.ApiController.extend({
      itemController: 'uploadsItem'
    });

    Dig.UploadsItemController = Dig.ApiItemController.extend(Em.Evented, {
      needs: 'nowPlaying'.w(),
      nowPlaying: Em.computed.alias('controllers.nowPlaying'),

      isPlaying: false,

      userQuery: function() {
        var name = this.get('user_name');
        if (name) {
          return 'u='+name;
        }
      }.property('user_name'),

      streamUrl: function() {
        var files = this.get('content.files');
        if (Em.isArray(files)) {
          // TODO: Search list and make sure we try to get a streamable file instead of zip
          return files.get('firstObject.download_url');
        }
      }.property('content.files'),

      /*
      license_logo_url: function() {
        // TODO: Make this work to pull correct images from dig
        return "http://dig.ccmixter.org/images/" + this.get('license_name').dasherize() + '.png';
      }.property('license_name'),
      */

      sound: function(key, value, oldValue) {
        var item = this,
            streamUrl = this.get('streamUrl');
        if (streamUrl) {
          return soundManager.createSound({
            url: streamUrl,
            onplay: function() {
              Em.run(function() {
                item.set('nowPlaying.content', item);
                item.set('nowPlaying.currentSound', item.get('sound'));
                item.set('isPlaying', true);
                item.trigger('onPlay');
              });
            },
            onstop: function() {
              Em.run(function() {
                item.set('isPlaying', false);
                item.trigger('onStop');
              });
            },
            onfinish: function() {
              Em.run(function() {
                item.set('isPlaying', false);
                item.trigger('onFinish');
              });
            }
          });
        }
      }.property('streamUrl'),

      stop: function() {
        var sound = this.get('sound');
        if (sound) {
          sound.stop();
        }
      },

      play: function() {
        var sound = this.get('sound');
        if (sound) {
          sound.play();
        }
      },

      togglePlay: function() {
        if (this.get('isPlaying')) {
          this.stop();
        } else {
          this.play();
        }
      },

      actions: {
        togglePlay: function() {
          this.togglePlay();
        }
      }
    });

    Dig.NowPlayingController = Em.ObjectController.extend({
      needs: 'uploads'.w(),
      tracks: Em.computed.alias('controllers.uploads'),

      currentSound: null,

      shouldLoadFirstItem:  false,
      shouldContinuousPlay: true,

      trackIndex: function() {
        var track = this.get('content'),
            tracks = this.get('tracks');
        if (track && Em.isArray(tracks)) {
          return tracks.indexOf(track);
        }
        return -1;
      }.property('tracks.@each', 'content'),

      nextTrack: function() {
        var tracks = this.get('tracks'),
            trackIndex = this.get('trackIndex') + 1;
        if (!tracks.get('length')) {return;}
        if (trackIndex >= tracks.get('length')) {
          trackIndex = 0;
        }
        return tracks.objectAt(trackIndex);
      }.property('trackIndex', 'tracks.@each'),

      previousTrack: function() {
        var tracks = this.get('tracks'),
            trackIndex = this.get('trackIndex') - 1;
        if (!tracks.get('length')) {return;}
        if (trackIndex < 0) {
          trackIndex = tracks.get('length') - 1;
        }
        return tracks.objectAt(trackIndex);
      }.property('trackIndex', 'tracks.@each'),

      playNextTrack: function() {
        var next = this.get('nextTrack');
        if (next) {next.play();}
      },

      playPreviousTrack: function() {
        var previous = this.get('previousTrack');
        if (previous) {previous.play();}
      },

      didFinishTrack: function() {
        if (this.get('shouldContinuousPlay')) {
          this.playNextTrack();
        }
      },

      trackWillChange: function() {
        var track = this.get('content');
        if (track) {
          track.off('onFinish', this, this.didFinishTrack);
          track.stop();
        }
      }.observesBefore('content'),

      soundWillChange: function() {
        var sound = this.get('currentSound');
        if (sound) {
          sound.stop();
        }
      }.observesBefore('currentSound'),

      trackDidChange: function() {
        var track = this.get('content');
        if (track) {
          track.on('onFinish', this, this.didFinishTrack);
        }
      }.observes('content'),

      setInitialItem: function() {
        if (this.get('shouldLoadFirstItem')) {
          var content = this.get('content'),
              tracks = this.get('tracks');
          if (!content && tracks.get('length')) {
            this.set('content', tracks.objectAt(0));
          }
        }
      }.observes('content', 'tracks.@each').on('init')
    });

    // END CONTROLLERS

    soundManager.setup({
      url: 'soundmanagerv297a-20131201/swf/',
      debugMode: false
    });
  </script>
</body>
</html>
